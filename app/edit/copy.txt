"use client";

import React, { useEffect, useMemo, useRef, useState } from "react";
import type { SupabaseClient } from "@supabase/supabase-js";
import { getSupabase } from "@/lib/supabaseClient";
import { listTemplates, toPublicUrl } from "@/lib/dbApi";
import { useRouter } from "next/navigation";

/* ---------------- Types ---------------- */
type TextLayer = {
  id: string;
  label: string;
  text: string;
  x: number;
  y: number;
  width: number;
  fontSize: number;
  color: string;
  weight: number;
  align: "left" | "center" | "right";
  uppercase?: boolean;
  italic?: boolean;
  shadow?: boolean;
};

type TemplateRowLite = {
  id: string;
  name: string;
  width: number;
  height: number;
  bg_path?: string | null;
  icon_path?: string | null;
  text_layers: TextLayer[];
};

/* ---------------- Utils & Constants ---------------- */
const placeholder =
  "https://upload.wikimedia.org/wikipedia/commons/a/ac/No_image_available.svg";

const DEFAULT_LOGO =
  "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAEYCAMAAADCuiwhAAAA8FBMVEX///9FGwr93ABBEwBCFQDt6edDFwBEGQY6AADY0M44AAD5+Pc+CgD8+/ptTkE8AABEDgD/+d3/5hH/4gD+8aSQenTm4N3//Oz//vn//vKzp6P+63r+75D+6Wry7+3/6jb/7lL+9Lj/+dExAABgPzXPxMAvAABXLx+7rag9CAB+Y1meioOtnZfe19TBtrFyVUopAACIb2Whj4ggAABWNCn+867++NL+8aCCaV9OJBJ5XVJZNyyTf3jKvrpKGwBlRTn95lL940D96GL+7If+7Hf/7D1VKxlcNCRZOTBjSkRQLSJsVE5OGgBKJRqTe3FwTkCBhotnAAATBElEQVR4nO1deX/SStsOZCMbia3EihqtkJI9JVYlQILLOWDbR/z+3+bNhC5AZibUZCjn/XH9cY7aFC7uuefeZ6Coajj7erb7w68qvlldeNE83/3Zb7s/SxTnzZOPOz764nuzueuz2RI+YQWfipfN5rcXOz35+t1ps/l+t2czzm92ffIvkJE+fb..."; // ç•¥

type LogoState = { url: string | null; isDefault: boolean };

function safeKey(name: string) {
  return name
    .trim()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/[^\w\-]+/g, "_")
    .replace(/_+/g, "_")
    .replace(/^_+|_+$/g, "")
    .toLowerCase();
}

function baseName(name: string) {
  if (!name) return "";
  const half = name.replace(/[ï¼-ï¼™]/g, (d) =>
    String.fromCharCode(d.charCodeAt(0) - 0xfee0)
  );
  return half.trim().replace(/(?:[\s_-]*?(?:æ¬¾|ç‰ˆ)?)?\s*[_\- ]*\d+\s*$/u, "");
}

function tailNumber(s: string) {
  s = s.replace(/[ï¼-ï¼™]/g, (d) =>
    String.fromCharCode(d.charCodeAt(0) - 0xfee0)
  );
  const m = s.match(/(\d+)\s*$/);
  return m ? parseInt(m[1], 10) : -1;
}

const FIELD_KEYS = [
  { key: "school", match: /è£œç¿’ç­|æ©Ÿæ§‹|ç­å|åº—å|åç¨±/i, label: "è£œç¿’ç­åç¨±ï¼š" },
  { key: "date", match: /æ—¥æœŸ|time|day|æ™‚æ®µ/i, label: "èª²ç¨‹æ—¥æœŸï¼š" },
  { key: "phone", match: /å°ˆç·š|é›»è©±|phone|è¯çµ¡/i, label: "å ±åå°ˆç·šï¼š" },
  { key: "addr", match: /åœ°å€|åœ°é»|address|ä¸Šèª²åœ°é»/i, label: "ä¸Šèª²åœ°å€ï¼š" },
] as const;

const CATEGORY_STYLES: Record<string, { dot: string; pill: string }> = {
  "å‰µæ„æ‰‹ä½œ": { dot: "bg-[#F2A7AF]", pill: "bg-[#F2A7AF] text-white" },
  "ç›Šæ™ºæŒ‘æˆ°": { dot: "bg-[#EFAB67]", pill: "bg-[#EFAB67] text-white" },
  "STEAMå•Ÿèˆª": { dot: "bg-[#799DBF]", pill: "bg-[#799DBF] text-white" },
  "å¾‹å‹•ç¯€å¥": { dot: "bg-[#D389C2]", pill: "bg-[#D389C2] text-white" },
  å…¶ä»–: { dot: "bg-slate-300", pill: "bg-slate-500 text-white" },
};

function guessCategory(name: string): string {
  name = baseName(name);
  if (/3Dç­†|æ‹¼è±†|é»åœŸ|æ°´ç |æ°£çƒ/i.test(name)) return "å‰µæ„æ‰‹ä½œ";
  if (/å¡ç‰Œ|æ¡ŒéŠ|é­”æ–¹|é­”è¡“|å¸ç®¡|éª¨ç‰Œ/i.test(name)) return "ç›Šæ™ºæŒ‘æˆ°";
  if (/æ©Ÿæ¢°|ç§‘å­¸|æ˜†èŸ²|AI|ç©æœ¨/i.test(name)) return "STEAMå•Ÿèˆª";
  if (/ç–Šæ¯|å¡æ—å·´|èˆè¹ˆ|é«”é©èƒ½/i.test(name)) return "å¾‹å‹•ç¯€å¥";
  return "å…¶ä»–";
}

function representativesByBase(list: TemplateRowLite[]) {
  const map = new Map<string, TemplateRowLite[]>();
  list.forEach((t) => {
    const b = baseName(t.name);
    if (!map.has(b)) map.set(b, []);
    map.get(b)!.push(t);
  });
  const reps: TemplateRowLite[] = [];
  for (const arr of map.values()) {
    arr.sort((a, b) => {
      const na = tailNumber(a.name),
        nb = tailNumber(b.name);
      if (na === nb) return a.name.localeCompare(b.name, "zh-Hant");
      return na - nb;
    });
    reps.push(arr[0]);
  }
  return reps;
}

/* ---------------- Page ---------------- */
export default function BPage() {
  const supabase = useMemo<SupabaseClient>(() => getSupabase(), []);
  const router = useRouter();

  // ğŸ§© ç™»å…¥å®ˆé–€
  const [checking, setChecking] = useState(true);
  const [authed, setAuthed] = useState(false);

  useEffect(() => {
    let canceled = false;
    (async () => {
      const { data, error } = await supabase.auth.getSession();
      if (canceled) return;

      const session = data?.session;
      if (!session || error) {
        const redirect = encodeURIComponent(
          window.location.pathname + window.location.search || "/edit"
        );
        router.replace(`/edit/login?redirect=${redirect}`);
        return;
      }

      setAuthed(true);
      setChecking(false);
    })();

    return () => {
      canceled = true;
    };
  }, [router, supabase]);

  if (checking)
    return (
      <div className="min-h-screen flex items-center justify-center text-slate-500">
        æª¢æŸ¥ç™»å…¥ä¸­â€¦
      </div>
    );

  if (!authed) return null;

  /* ---------------- ä¸»å…§å®¹ ---------------- */
  const [templates, setTemplates] = useState<TemplateRowLite[]>([]);
  const [picked, setPicked] = useState<TemplateRowLite | null>(null);
  const [values, setValues] = useState<Record<string, string>>({});
  const [loading, setLoading] = useState(true);
  const [logo, setLogo] = useState<LogoState>({ url: null, isDefault: false });
  const [logoPos, setLogoPos] = useState({ x: 0, y: 0, size: 300 });

  const previewWrapOuterRef = useRef<HTMLDivElement>(null);
  const stageWrapRef = useRef<HTMLDivElement>(null);
  const [wrapWidth, setWrapWidth] = useState<number>(0);

  useEffect(() => {
    (async () => {
      setLoading(true);
      const rows = await listTemplates();
      const mapped: TemplateRowLite[] = rows.map((r: any) => ({
        id: r.id,
        name: r.name,
        width: r.width,
        height: r.height,
        bg_path: r.bg_path,
        icon_path: r.icon_path ?? `icons/icon-${safeKey(r.name)}.png`,
        text_layers: r.text_layers,
      }));
      setTemplates(mapped);
      const W = 1080, H = 1528, S = 300;
      setLogo({ url: DEFAULT_LOGO, isDefault: true });
      setLogoPos({ x: (W - S) / 2, y: (H - S) / 2, size: S });
      setLoading(false);
    })();
  }, []);

  useEffect(() => {
    const el = previewWrapOuterRef.current;
    if (!el) return;
    const ro = new ResizeObserver((entries) =>
      entries.forEach((e) => setWrapWidth(Math.floor(e.contentRect.width)))
    );
    ro.observe(el);
    return () => ro.disconnect();
  }, []);

  /* ---------------- æ¸²æŸ“ ---------------- */
  const w = picked?.width ?? 1080;
  const h = picked?.height ?? 1528;
  const scale = Math.min((wrapWidth || 480) / w, 1);

   return (
    // âœ… é€™è£¡åŠ ä¸Š data-b-sideï¼Œè®“ç™½åº•è¦å‰‡åªåœ¨ B ç«¯ç”Ÿæ•ˆ
    <div data-b-side className="min-h-screen flex flex-col bg-white font-[GenYoGothicTW]">
      {/* âœ… ä¸»è¦å…§å®¹åŒ…åœ¨ flex-1 çš„ <main> ä¸­ */}
      <main className="flex-1">
        <div className="max-w-[1180px] mx-auto p-4 sm:p-6 lg:p-8 grid grid-cols-1 lg:grid-cols-12 gap-6 lg:gap-10">
          {/* å·¦ï¼šé è¦½å€ */}
          <div className="lg:col-span-5">
            <div className="mb-3 inline-flex items-center gap-2">
              <span className="inline-block px-4 py-1 rounded-full bg-black text-white text-[14px] font-bold shadow">
                æµ·å ±é è¦½
              </span>
            </div>

            {/* å¤–å±¤ï¼šè² è²¬é‡æ¸¬å¯¬åº¦ */}
            <div ref={previewWrapOuterRef} className="w-full">
              {/* å…§å±¤ï¼šå¯¦éš›é¡¯ç¤ºæ¡† */}
              <div
                className="relative mx-auto shadow rounded border border-slate-200 bg-white"
                style={{ width: "100%", height: Math.round(h * scale) }}
                ref={stageWrapRef}
              >
                <div
                  data-stage
                  className="absolute top-0 left-0"
                  style={{
                    width: w,
                    height: h,
                    transform: `scale(${scale})`,
                    transformOrigin: "top left",
                    backgroundImage: picked?.bg_path
                      ? `url(${toPublicUrl(encodeURI(picked.bg_path))})`
                      : "none",
                    backgroundSize: "cover",
                    backgroundPosition: "center",
                    // âœ… å¼·åˆ¶å­—é«”ï¼ˆç•«å¸ƒå…§ï¼‰
                    fontFamily: `"GenYoGothicTW","Noto Sans TC",sans-serif`,
                  }}
                >
                  {/* æ–‡å­—å±¤ï¼šé¸äº†æ¨¡æ¿æ‰é¡¯ç¤º */}
                  {picked &&
                    picked.text_layers.map((L) => (
                      <div
                        key={L.id}
                        className="absolute select-none px-1"
                        style={{
                          left: L.x,
                          top: L.y,
                          width: Math.max(1, L.width),
                          color: L.color,
                          fontSize: L.fontSize,
                          fontWeight: L.weight,
                          fontStyle: L.italic ? "italic" : "normal",
                          textAlign: L.align as any,
                          textTransform: L.uppercase ? "uppercase" : "none",
                          textShadow: L.shadow ? "0 2px 6px rgba(0,0,0,.35)" : "none",
                          lineHeight: 1.1,
                          whiteSpace: "pre-wrap",
                          wordBreak: "break-word",
                          zIndex: 10,
                        }}
                      >
                        {values[L.id] !== undefined ? values[L.id] : L.text}
                      </div>
                    ))}

                  {/* Logoï¼šé è¨­ä¸å¯æ‹–æ›³/ä¸å¯é»ï¼›å®¢æˆ¶ Logo å¯æ‹–æ›³ */}
                  {logo.url && (
                    <img
                      src={logo.url}
                      alt="Logo"
                      draggable={false}
                      onDragStart={(e) => e.preventDefault()}
                      style={{
                        position: "absolute",
                        left: logoPos.x,
                        top: logoPos.y,
                        width: logoPos.size,
                        height: "auto",
                        zIndex: 50,
                        cursor: logo.isDefault ? "default" : "grab",
                        pointerEvents: logo.isDefault ? "none" : "auto",
                        userSelect: "none",
                      }}
                      onMouseDown={(e) => {
                        if (logo.isDefault) return;
                        e.preventDefault();
                        const p = getStagePoint(e.clientX, e.clientY);
                        startDragLogo(p.x, p.y);
                      }}
                      onTouchStart={(e) => {
                        if (logo.isDefault) return;
                        const t = e.touches[0];
                        if (!t) return;
                        const p = getStagePoint(t.clientX, t.clientY);
                        startDragLogo(p.x, p.y);
                      }}
                    />
                  )}
                </div>
              </div>
            </div>

            {/* å·¦ä¸‹ï¼šåŒç³»åˆ—æ¨¡æ¿ï¼ˆæœªé¸æ¨¡æ¿ä¸é¡¯ç¤ºï¼‰ */}
            {picked && siblings.length > 0 && (
              <div className="mt-6">
                <div className="text-[13px] mb-2 font-semibold text-slate-700">
                  é¸æ“‡æ¨¡æ¿
                </div>
                <div className="flex gap-3">
                  {siblings.map((tpl) => (
                    <button
                      key={tpl.id}
                      onClick={() => setPicked(tpl)}
                      className={`w-14 h-16 rounded-xl shadow border overflow-hidden ${
                        picked?.id === tpl.id ? "ring-2 ring-black" : ""
                      }`}
                      title={tpl.name}
                    >
                      <img
                        src={getThumbFromBg(tpl)}
                        onError={(e) => (e.currentTarget.src = placeholder)}
                        className="w-full h-full object-cover"
                        alt={tpl.name}
                        draggable={false}
                      />
                    </button>
                  ))}
                </div>
              </div>
            )}

            {/* ä¸Šå‚³ / æ§åˆ¶ Logoï¼ˆé è¨­æ™‚ç¦ç”¨æ§åˆ¶ï¼‰ */}
            <div className="mt-6">
              <div className="text-[13px] mb-2 font-semibold text-slate-700">
                ä¸Šå‚³LOGO
              </div>
              <label className="w-16 h-16 rounded-xl border-2 border-dashed border-slate-300 grid place-items-center cursor-pointer hover:border-slate-400">
                <span className="text-2xl">ï¼‹</span>
                <input
                  type="file"
                  className="hidden"
                  accept="image/*"
                  onChange={(e) => {
                    const file = e.target.files?.[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = () => {
                      setLogo({ url: reader.result as string, isDefault: false });
                      const W = picked?.width ?? 1080;
                      const H = picked?.height ?? 1528;
                      const S = 300;
                      setLogoPos({ x: (W - S) / 2, y: (H - S) / 2, size: S });
                    };
                    reader.readAsDataURL(file);
                  }}
                />
              </label>

              {logo.url && (
                <div className="mt-3 space-y-3">
                  <div className="flex flex-wrap items-center gap-2">
                    <label className="text-sm">å¤§å°ï¼š</label>
                    <input
                      type="range"
                      min="40"
                      max="320"
                      value={logoPos.size}
                      disabled={logo.isDefault}
                      onChange={(e) =>
                        setLogoPos((o) => ({ ...o, size: +e.target.value }))
                      }
                      className="w-full sm:w-64"
                    />
                    <span className="text-xs text-slate-500">
                      {logoPos.size}px
                    </span>
                  </div>
                  <div className="flex flex-wrap items-center gap-2">
                    <span className="text-sm">ä½ç½®ï¼š</span>
                    <div className="flex gap-2">
                      {[
                        { k: "up", fn: () => setLogoPos((o) => ({ ...o, y: o.y - 1 })) },
                        { k: "down", fn: () => setLogoPos((o) => ({ ...o, y: o.y + 1 })) },
                        { k: "left", fn: () => setLogoPos((o) => ({ ...o, x: o.x - 1 })) },
                        { k: "right", fn: () => setLogoPos((o) => ({ ...o, x: o.x + 1 })) },
                      ].map(({ k, fn }) => (
                        <button
                          key={k}
                          onClick={!logo.isDefault ? fn : undefined}
                          disabled={logo.isDefault}
                          className={`px-2 py-1 border rounded ${
                            logo.isDefault ? "opacity-50 cursor-not-allowed" : ""
                          }`}
                        >
                          {k === "up" ? "â†‘" : k === "down" ? "â†“" : k === "left" ? "â†" : "â†’"}
                        </button>
                      ))}
                    </div>
                    <button
                      onClick={() => setLogo({ url: null, isDefault: false })} // çœŸçš„æ¸…ç©º
                      className="ml-0 sm:ml-3 px-3 py-1.5 rounded-lg bg-red-500 text-white text-sm shadow hover:bg-red-600 active:scale-95"
                    >
                      åˆªé™¤ Logo
                    </button>
                  </div>
                </div>
              )}
            </div>
          </div>

          {/* å³ï¼šé¸èª² + è¡¨å–® + ä¸‹è¼‰ */}
          <div className="lg:col-span-7">
            <div className="mb-6">
              <span className="inline-block px-4 py-1 rounded-full bg-black text-white text-[14px] font-bold shadow">
                é¸æ“‡èª²ç¨‹
              </span>

              <div className="mt-4 space-y-6">
                {loading ? (
                  <div className="text-slate-500">è¼‰å…¥ä¸­â€¦</div>
                ) : (
                  grouped.map((grp) => {
                    const s =
                      CATEGORY_STYLES[grp.name] ?? CATEGORY_STYLES["å…¶ä»–"];
                    return (
                      <div key={grp.name}>
                        <div className="flex items-center gap-2 mb-2">
                          <span
                            className={`inline-block w-2 h-2 rounded-full ${s.dot}`}
                          />
                          <span
                            className={`text-[12px] px-3 py-1 rounded-full ${s.pill}`}
                          >
                            {grp.name}
                          </span>
                          <div className="grow border-dotted border-b border-slate-300 ml-2" />
                        </div>
                        <div className="flex flex-wrap gap-2 sm:gap-3">
                          {grp.items.map((t) => {
                            const iconUrl = getIconUrl(t);
                            return (
                              <button
                                key={t.id}
                                onClick={() => selectTemplate(t)}
                                className={`w-[72px] h-[72px] p-1 rounded-xl border hover:shadow transition flex items-center justify-center ${
                                  picked?.id === t.id
                                    ? "ring-2 ring-slate-900"
                                    : ""
                                } icon-tile`}  // ğŸ‘ˆ ä¿è­‰ç™½åº•é»‘å­—
                                title={baseName(t.name)}
                              >
                                <img
                                  src={iconUrl}
                                  onError={(e) =>
                                    ((e.currentTarget.src = placeholder))
                                  }
                                  className="w-[56px] h-[56px] object-contain"
                                  alt={baseName(t.name)}
                                />
                              </button>
                            );
                          })}
                        </div>
                      </div>
                    );
                  })
                )}
              </div>
            </div>

            {/* è¼¸å…¥è³‡è¨Šå››æ¬„ */}
            <div className="mb-6">
              <span className="inline-block px-4 py-1 rounded-full bg-black text-white text-[14px] font-bold shadow">
                è¼¸å…¥è³‡è¨Š
              </span>

            <div className="mt-4 space-y-3">
              {FIELD_KEYS.map(({ key, match, label }) => (
                <div key={key} className="flex flex-wrap items-center gap-2 sm:gap-3">
                  <label className="w-full sm:w-32 text-sm text-slate-700">{label}</label>
                  <input
                    className="min-w-0 flex-1 w-full sm:w-auto px-3 py-2 rounded-lg border focus:ring-2 focus:ring-slate-900/30 outline-none"
                    placeholder="è«‹è¼¸å…¥â€¦"
                    value={
                      picked
                        ? (() => {
                            const hit = picked.text_layers.find((l) =>
                              match.test(l.label)
                            );
                            return hit ? values[hit.id] ?? "" : "";
                          })()
                        : ""
                    }
                    onChange={(e) => setFieldForLabel(match, e.target.value)}
                  />
                </div>
              ))}
            </div>
            </div>

            {/* ä¸‹è¼‰ï¼šPNG / PDF */}
            <div className="mt-2 flex flex-wrap gap-3">
              <button
                onClick={downloadPNG}
                className="px-6 py-3 rounded-full bg-slate-900 text-white font-semibold shadow active:scale-95 transition inline-flex items-center gap-2"
              >
                ä¸‹è¼‰ PNG åœ–æª”
                <svg xmlns="http://www.w3.org/2000/svg" className="w-5 h-5"
                    viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <path d="M12 4v10" />
                  <path d="M8 10l4 4 4-4" />
                  <path d="M4 20h16" />
                </svg>
              </button>

              <button
                onClick={downloadPDF}
                className="px-6 py-3 rounded-full bg-slate-900 text-white font-semibold shadow active:scale-95 transition inline-flex items-center gap-2"
              >
                ä¸‹è¼‰ PDF åˆ—å°
                <svg xmlns="http://www.w3.org/2000/svg" className="w-5 h-5"
                    viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <path d="M12 4v10" />
                  <path d="M8 10l4 4 4-4" />
                  <path d="M4 20h16" />
                </svg>
              </button>
            </div>
          </div>
        </div>
      </main>
      <footer className="mt-10 bg-[#FFC840] text-[11px] sm:text-[12px] text-white/90 py-3 text-center tracking-wider px-3">
        åœ‹ç‹æ‰è— KING'S TALENT ï½œæœ¬å¹³å°æ¨¡æ¿ç”±åœ‹ç‹æ‰è—åŸå‰µè¨­è¨ˆï¼Œåƒ…é™è£œæ•™æ©Ÿæ§‹ä¹‹æ‹›ç”Ÿå®£å‚³ä½¿ç”¨ï¼Œè«‹å‹¿è½‰å”®ã€é‡è£½æˆ–ä½œå•†æ¥­ç”¨é€”ã€‚
      </footer>
    </div>
  );
}
